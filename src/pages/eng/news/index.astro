---
import type { Lang } from '@/i18n';
import { t, getBaseUrl } from '@/i18n';
import BaseLayout from '@/layouts/BaseLayout.astro';
import Breadcrumbs from '@/components/Breadcrumbs.astro';
import Faq from '@/components/Faq.astro';
import CtaFaq from '@/components/CtaFaq.astro';
import { getNewsArticles, newsCategories, formatDate, getPopularArticles } from '@/data/news';
import '@/styles/components/news.css';

const lang: Lang = 'en';
const base = getBaseUrl(lang);
const articles = getNewsArticles(lang);
const popularArticles = getPopularArticles(3);

const faqItems = [
  {
    question: "Where can I find information about new products?",
    answer: "We regularly publish information about new developments, equipment arrivals and technological solutions in the News section. Subscribe to our newsletter to stay updated on important news."
  },
  {
    question: "Do you participate in industry exhibitions?",
    answer: "Yes, RUSTRADE is an active participant in major energy exhibitions and conferences. We post event announcements and participation reports in this section."
  },
  {
    question: "Can I reprint materials from your website?",
    answer: "Use of site materials is permitted only with written permission from the copyright holder and with an active link to the source."
  }
];
---

<BaseLayout 
  lang={lang} 
  title="News and Articles about Steam Turbines â€” RUSTRADE"
  description="RUSTRADE company news, expert articles about steam turbines, energy efficiency and modern technologies in the energy sector. Up-to-date information from specialists."
  keywords="RUSTRADE news, turbine articles, energy news, steam turbine articles"
  activeMenu={t('news.title', lang)}
  faqData={faqItems}
  breadcrumbs={[{ name: 'News & Articles', url: '/eng/news' }]}
>
  <Breadcrumbs items={[{ label: 'News & Articles' }]} lang={lang} />

  <div class="news-page">
    <div class="news-page-header">
      <div class="news-header-info">
        <h1>News & Articles</h1>
        <p class="news-count">Found: <span id="news-count">{articles.length}</span> <span id="news-count-label">articles</span></p>
      </div>
      <div class="view-switcher-wrapper">
        <div class="view-switcher">
          <button id="view-grid" class="view-btn active" aria-label="Grid view">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M3,3V11H11V3M9,9H5V5H9M3,13V21H11V13M9,19H5V15H9M13,3V11H21V3M19,9H15V5H19M13,13V21H21V13M19,19H15V15H19Z"/>
            </svg>
          </button>
          <button id="view-list" class="view-btn" aria-label="List view">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M3,4H21V6H3V4M3,11H21V13H3V11M3,18H21V20H3V18Z"/>
            </svg>
          </button>
        </div>
      </div>
    </div>

    <div class="news-layout">
      <!-- Main Content -->
      <div class="news-main">
        <main class="news-content">
          <div id="news-container" class="news-grid">
            {articles.map((article, idx) => (
              <a 
                href={`${base}/news/${article.slug}`} 
                class="news-card" 
                data-category={article.category} 
                data-full-excerpt={article.excerpt[lang]}
              >
                <div class="news-card-image">
                  <img src={article.image} alt={article.title[lang]} loading={idx < 4 ? "eager" : "lazy"} />
                  <span class="news-card-category">{newsCategories[article.category]?.[lang]}</span>
                </div>
                <div class="news-card-body">
                  <div class="news-card-meta">
                    <span class="news-date">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                        <line x1="16" y1="2" x2="16" y2="6"/>
                        <line x1="8" y1="2" x2="8" y2="6"/>
                        <line x1="3" y1="10" x2="21" y2="10"/>
                      </svg>
                      {formatDate(article.date, lang)}
                    </span>
                  </div>
                  <h2 class="news-title">{article.title[lang]}</h2>
                  <p class="news-excerpt">{article.excerpt[lang]}</p>
                  <div class="news-card-footer">
                    <span class="read-more">
                      Read more
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M5 12h14M12 5l7 7-7 7"/>
                      </svg>
                    </span>
                  </div>
                </div>
              </a>
            ))}
          </div>
        </main>
      </div>

      <!-- Sidebar -->
      <aside class="news-sidebar">
        <!-- Search Block -->
        <div class="sidebar-block sidebar-search">
          <h3>Search</h3>
          <div class="search-input-wrapper">
            <input type="text" id="search-input" placeholder="Enter keyword..." />
            <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"/>
              <path d="m21 21-4.35-4.35"/>
            </svg>
          </div>
        </div>

        <!-- Categories Block - Horizontal Buttons -->
        <div class="sidebar-block sidebar-categories">
          <h3>Categories</h3>
          <div class="filter-tags-horizontal">
            <button class="filter-tag-pill active" data-category="all">All</button>
            {Object.entries(newsCategories).map(([key, value]) => (
              <button class="filter-tag-pill" data-category={key}>{value[lang]}</button>
            ))}
          </div>
        </div>

        <!-- Popular Posts Block -->
        <div class="sidebar-block sidebar-popular">
          <h3>Popular Articles</h3>
          <div class="popular-posts-list">
            {popularArticles.map((article) => (
              <a href={`${base}/news/${article.slug}`} class="popular-post-item">
                <div class="popular-post-image">
                  <img src={article.image} alt={article.title[lang]} loading="lazy" />
                </div>
                <div class="popular-post-content">
                  <span class="popular-post-title">{article.title[lang]}</span>
                  <span class="popular-post-date">{formatDate(article.date, lang)}</span>
                </div>
              </a>
            ))}
          </div>
        </div>
      </aside>
    </div>

    <section class="page-description">
      <h2>RUSTRADE: Stay Informed About the Energy World</h2>
      <p>
        This section is designed to keep you informed about the most important and interesting events in the world of energy and steam turbines. Here we share RUSTRADE company news, talk about new project launches, and announce participation in key industry exhibitions and conferences.
      </p>
      <p>
        Follow our publications to be the first to learn about technological innovations, trends and get practical advice from experts. We strive to be not just a supplier of quality turbines, but also a reliable source of inspiration and up-to-date information.
      </p>
    </section>

    <Faq items={faqItems} lang={lang} />

    <CtaFaq lang={lang} />
  </div>
</BaseLayout>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const gridButton = document.getElementById('view-grid');
    const listButton = document.getElementById('view-list');
    const newsContainer = document.getElementById('news-container');
    const newsItems = Array.from(document.querySelectorAll('#news-container > a'));
    const newsCountSpan = document.getElementById('news-count');
    const searchInput = document.getElementById('search-input') as HTMLInputElement;
    const filterButtons = document.querySelectorAll('.filter-tag-pill');

    function pluralize(count: number, forms: string[]) {
      // English pluralization - simple
      return count === 1 ? forms[0] : forms[1];
    }

    const newsCountLabel = document.getElementById('news-count-label');

    function updateCounter() {
      const visibleItems = newsItems.filter(item => (item as HTMLElement).style.display !== 'none').length;
      const activeCategoryButton = document.querySelector('.filter-tag-pill.active');
      const selectedCategory = activeCategoryButton?.getAttribute('data-category') || 'all';
      
      let forms: string[];
      if (selectedCategory === 'all') {
        forms = ['article', 'articles'];
      } else if (selectedCategory === 'company' || selectedCategory === 'industry') {
        forms = ['news item', 'news items'];
      } else if (selectedCategory === 'articles') {
        forms = ['article', 'articles'];
      } else {
        forms = ['article', 'articles'];
      }
      
      if (newsCountSpan) {
        newsCountSpan.textContent = String(visibleItems);
      }
      if (newsCountLabel) {
        newsCountLabel.textContent = pluralize(visibleItems, forms);
      }
    }

    function switchView(isGrid: boolean) {
      gridButton?.classList.toggle('active', isGrid);
      listButton?.classList.toggle('active', !isGrid);
      if (newsContainer) {
        newsContainer.className = isGrid ? 'news-grid' : 'news-list';
      }
      applyFilters();
    }

    function applyFilters() {
      const searchQuery = searchInput?.value.toLowerCase() || '';
      const activeCategoryButton = document.querySelector('.filter-tag-pill.active');
      const selectedCategory = activeCategoryButton?.getAttribute('data-category') || 'all';
      const isGridView = newsContainer?.classList.contains('news-grid');

      newsItems.forEach(item => {
        const title = item.querySelector('.news-title')?.textContent?.toLowerCase().trim() || '';
        const date = item.querySelector('.news-date')?.textContent?.toLowerCase().trim() || '';
        const fullExcerpt = (item as HTMLElement).dataset.fullExcerpt?.toLowerCase().trim() || '';
        const itemCategory = item.getAttribute('data-category');

        const categoryMatch = (selectedCategory === 'all' || itemCategory === selectedCategory);
        const searchMatch = (title.includes(searchQuery) || date.includes(searchQuery) || fullExcerpt.includes(searchQuery));

        const excerptP = item.querySelector('.news-excerpt');

        if (isGridView) {
          const words = (item as HTMLElement).dataset.fullExcerpt?.split(' ') || [];
          const shortText = words.slice(0, 20).join(' ') + (words.length > 20 ? '...' : '');
          if (excerptP) excerptP.textContent = shortText;
          item.className = 'news-card';
        } else {
          if (excerptP) excerptP.textContent = (item as HTMLElement).dataset.fullExcerpt || '';
          item.className = 'news-list-item';
        }

        if (categoryMatch && searchMatch) {
          (item as HTMLElement).style.display = '';
        } else {
          (item as HTMLElement).style.display = 'none';
        }
      });
      updateCounter();
    }

    gridButton?.addEventListener('click', () => switchView(true));
    listButton?.addEventListener('click', () => switchView(false));
    searchInput?.addEventListener('input', applyFilters);

    filterButtons.forEach(button => {
      button.addEventListener('click', () => {
        filterButtons.forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
        applyFilters();
      });
    });

    // Initialize
    switchView(true);
  });
</script>
