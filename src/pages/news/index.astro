---
import type { Lang } from '@/i18n';
import { t, getBaseUrl } from '@/i18n';
import BaseLayout from '@/layouts/BaseLayout.astro';
import Breadcrumbs from '@/components/Breadcrumbs.astro';
import Faq from '@/components/Faq.astro';
import CtaFaq from '@/components/CtaFaq.astro';
import { getNewsArticles, newsCategories, formatDate, getPopularArticles } from '@/data/news';
import '@/styles/components/news.css';

const lang: Lang = 'ru';
const base = getBaseUrl(lang);
const articles = getNewsArticles(lang);
const popularArticles = getPopularArticles(3);

const faqItems = [
  {
    question: "Где можно найти информацию о новых продуктах?",
    answer: "Мы регулярно публикуем информацию о новых разработках, поступлениях оборудования и технологических решениях в разделе «Новости». Подпишитесь на нашу рассылку, чтобы не пропустить важные обновления."
  },
  {
    question: "Участвуете ли вы в отраслевых выставках?",
    answer: "Да, компания РУСТРЕЙД является активным участником крупнейших энергетических выставок и конференций. Анонсы мероприятий и отчеты об участии мы размещаем в этом разделе."
  },
  {
    question: "Можно ли перепечатывать материалы с вашего сайта?",
    answer: "Использование материалов сайта допускается только с письменного разрешения правообладателя и при наличии активной ссылки на источник."
  }
];
---

<BaseLayout 
  lang={lang} 
  title="Новости и статьи о паровых турбинах — РУСТРЕЙД"
  description="Новости компании РУСТРЕЙД, экспертные статьи о паровых турбинах, энергоэффективности и современных технологиях в энергетике. Актуальная информация от специалистов."
  keywords="новости РУСТРЕЙД, статьи о турбинах, новости энергетики, паровые турбины статьи"
  activeMenu={t('news.title', lang)}
  faqData={faqItems}
  breadcrumbs={[{ name: 'Новости и статьи', url: '/news' }]}
>
  <Breadcrumbs items={[{ label: 'Новости и статьи' }]} />

  <div class="news-page">
    <div class="news-page-header">
      <div class="news-header-info">
        <h1>Новости и статьи</h1>
        <p class="news-count">Найдено: <span id="news-count">{articles.length}</span> <span id="news-count-label">материалов</span></p>
      </div>
      <div class="view-switcher-wrapper">
        <div class="view-switcher">
          <button id="view-grid" class="view-btn active" aria-label="Вид сеткой">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M3,3V11H11V3M9,9H5V5H9M3,13V21H11V13M9,19H5V15H9M13,3V11H21V3M19,9H15V5H19M13,13V21H21V13M19,19H15V15H19Z"/>
            </svg>
          </button>
          <button id="view-list" class="view-btn" aria-label="Вид списком">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M3,4H21V6H3V4M3,11H21V13H3V11M3,18H21V20H3V18Z"/>
            </svg>
          </button>
        </div>
      </div>
    </div>

    <div class="news-layout">
      <!-- Main Content -->
      <div class="news-main">
        <main class="news-content">
          <div id="news-container" class="news-grid">
            {articles.map((article, idx) => (
              <a 
                href={`${base}/news/${article.slug}`} 
                class="news-card" 
                data-category={article.category} 
                data-full-excerpt={article.excerpt[lang]}
              >
                <div class="news-card-image">
                  <img src={article.image} alt={article.title[lang]} loading={idx < 4 ? "eager" : "lazy"} />
                  <span class="news-card-category">{newsCategories[article.category]?.[lang]}</span>
                </div>
                <div class="news-card-body">
                  <div class="news-card-meta">
                    <span class="news-date">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                        <line x1="16" y1="2" x2="16" y2="6"/>
                        <line x1="8" y1="2" x2="8" y2="6"/>
                        <line x1="3" y1="10" x2="21" y2="10"/>
                      </svg>
                      {formatDate(article.date, lang)}
                    </span>
                  </div>
                  <h2 class="news-title">{article.title[lang]}</h2>
                  <p class="news-excerpt">{article.excerpt[lang]}</p>
                  <div class="news-card-footer">
                    <span class="read-more">
                      Читать далее
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M5 12h14M12 5l7 7-7 7"/>
                      </svg>
                    </span>
                  </div>
                </div>
              </a>
            ))}
          </div>
        </main>
      </div>

      <!-- Sidebar -->
      <aside class="news-sidebar">
        <!-- Search Block -->
        <div class="sidebar-block sidebar-search">
          <h3>Поиск</h3>
          <div class="search-input-wrapper">
            <input type="text" id="search-input" placeholder="Введите ключевое слово..." />
            <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"/>
              <path d="m21 21-4.35-4.35"/>
            </svg>
          </div>
        </div>

        <!-- Categories Block - Horizontal Buttons -->
        <div class="sidebar-block sidebar-categories">
          <h3>Категории</h3>
          <div class="filter-tags-horizontal">
            <button class="filter-tag-pill active" data-category="all">Все</button>
            {Object.entries(newsCategories).map(([key, value]) => (
              <button class="filter-tag-pill" data-category={key}>{value[lang]}</button>
            ))}
          </div>
        </div>

        <!-- Popular Posts Block -->
        <div class="sidebar-block sidebar-popular">
          <h3>Популярные статьи</h3>
          <div class="popular-posts-list">
            {popularArticles.map((article) => (
              <a href={`${base}/news/${article.slug}`} class="popular-post-item">
                <div class="popular-post-image">
                  <img src={article.image} alt={article.title[lang]} loading="lazy" />
                </div>
                <div class="popular-post-content">
                  <span class="popular-post-title">{article.title[lang]}</span>
                  <span class="popular-post-date">{formatDate(article.date, lang)}</span>
                </div>
              </a>
            ))}
          </div>
        </div>
      </aside>
    </div>

    <section class="page-description">
      <h2>РУСТРЕЙД: В курсе событий мира энергетики</h2>
      <p>
        Этот раздел создан для того, чтобы держать вас в курсе самых важных и интересных событий в мире энергетики и паровых турбин. Здесь мы делимся новостями компании РУСТРЕЙД, рассказываем о запуске новых проектов, анонсируем участие в ключевых отраслевых выставках и конференциях.
      </p>
      <p>
        Следите за нашими публикациями, чтобы первыми узнавать о технологических инновациях, трендах и получать практические советы от экспертов. Мы стремимся быть для вас не просто поставщиком качественных турбин, но и надежным источником вдохновения и актуальной информации.
      </p>
    </section>

    <Faq items={faqItems} />

    <CtaFaq />
  </div>
</BaseLayout>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const gridButton = document.getElementById('view-grid');
    const listButton = document.getElementById('view-list');
    const newsContainer = document.getElementById('news-container');
    const newsItems = Array.from(document.querySelectorAll('#news-container > a'));
    const newsCountSpan = document.getElementById('news-count');
    const searchInput = document.getElementById('search-input') as HTMLInputElement;
    const filterButtons = document.querySelectorAll('.filter-tag-pill');

    function pluralize(count: number, forms: string[]) {
      const n = Math.abs(count) % 100;
      const n1 = n % 10;
      if (n > 10 && n < 20) return forms[2];
      if (n1 > 1 && n1 < 5) return forms[1];
      if (n1 === 1) return forms[0];
      return forms[2];
    }

    const newsCountLabel = document.getElementById('news-count-label');

    function updateCounter() {
      const visibleItems = newsItems.filter(item => (item as HTMLElement).style.display !== 'none').length;
      const activeCategoryButton = document.querySelector('.filter-tag-pill.active');
      const selectedCategory = activeCategoryButton?.getAttribute('data-category') || 'all';
      
      let forms: string[];
      if (selectedCategory === 'all') {
        // Все → материал/материала/материалов
        forms = ['материал', 'материала', 'материалов'];
      } else if (selectedCategory === 'company' || selectedCategory === 'industry') {
        // Новости компании или Новости отрасли → новость/новости/новостей
        forms = ['новость', 'новости', 'новостей'];
      } else if (selectedCategory === 'articles') {
        // Полезные статьи → статья/статьи/статей
        forms = ['статья', 'статьи', 'статей'];
      } else {
        forms = ['материал', 'материала', 'материалов'];
      }
      
      if (newsCountSpan) {
        newsCountSpan.textContent = String(visibleItems);
      }
      if (newsCountLabel) {
        newsCountLabel.textContent = pluralize(visibleItems, forms);
      }
    }

    function switchView(isGrid: boolean) {
      gridButton?.classList.toggle('active', isGrid);
      listButton?.classList.toggle('active', !isGrid);
      if (newsContainer) {
        newsContainer.className = isGrid ? 'news-grid' : 'news-list';
      }
      applyFilters();
    }

    function applyFilters() {
      const searchQuery = searchInput?.value.toLowerCase() || '';
      const activeCategoryButton = document.querySelector('.filter-tag-pill.active');
      const selectedCategory = activeCategoryButton?.getAttribute('data-category') || 'all';
      const isGridView = newsContainer?.classList.contains('news-grid');

      newsItems.forEach(item => {
        const title = item.querySelector('.news-title')?.textContent?.toLowerCase().trim() || '';
        const date = item.querySelector('.news-date')?.textContent?.toLowerCase().trim() || '';
        const fullExcerpt = (item as HTMLElement).dataset.fullExcerpt?.toLowerCase().trim() || '';
        const itemCategory = item.getAttribute('data-category');

        const categoryMatch = (selectedCategory === 'all' || itemCategory === selectedCategory);
        const searchMatch = (title.includes(searchQuery) || date.includes(searchQuery) || fullExcerpt.includes(searchQuery));

        const excerptP = item.querySelector('.news-excerpt');

        if (isGridView) {
          const words = (item as HTMLElement).dataset.fullExcerpt?.split(' ') || [];
          const shortText = words.slice(0, 20).join(' ') + (words.length > 20 ? '...' : '');
          if (excerptP) excerptP.textContent = shortText;
          item.className = 'news-card';
        } else {
          if (excerptP) excerptP.textContent = (item as HTMLElement).dataset.fullExcerpt || '';
          item.className = 'news-list-item';
        }

        if (categoryMatch && searchMatch) {
          (item as HTMLElement).style.display = '';
        } else {
          (item as HTMLElement).style.display = 'none';
        }
      });
      updateCounter();
    }

    gridButton?.addEventListener('click', () => switchView(true));
    listButton?.addEventListener('click', () => switchView(false));
    searchInput?.addEventListener('input', applyFilters);

    filterButtons.forEach(button => {
      button.addEventListener('click', () => {
        filterButtons.forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
        applyFilters();
      });
    });

    // Initialize
    switchView(true);
  });
</script>

